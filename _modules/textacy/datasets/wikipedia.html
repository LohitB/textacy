
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>textacy.datasets.wikipedia &#8212; textacy 0.6.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for textacy.datasets.wikipedia</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Wikipedia</span>
<span class="sd">---------</span>

<span class="sd">All articles for a given language- and version-specific Wikipedia site snapshot.</span>

<span class="sd">Records include the following fields:</span>

<span class="sd">    * ``text``: Text content of the article, with markup stripped out.</span>
<span class="sd">    * ``title``: Title of the Wikipedia article.</span>
<span class="sd">    * ``page_id``: Unique identifier of the page, usable in Wikimedia APIs.</span>
<span class="sd">    * ``wiki_links``: A list of other article pages linked to from this page.</span>
<span class="sd">    * ``ext_links``: A list of external URLs linked to from this page.</span>
<span class="sd">    * ``categories``: A list of Wikipedia categories to which this page belongs.</span>

<span class="sd">Site snapshots are generated by the Wikimedia Foundation; for more information,</span>
<span class="sd">refer to https://meta.wikimedia.org/wiki/Data_dumps.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">xml.etree.cElementTree</span> <span class="k">import</span> <span class="n">iterparse</span>

<span class="kn">import</span> <span class="nn">ftfy</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">mwparserfromhell</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">compat</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">data_dir</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="k">import</span> <span class="n">Dataset</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;wikipedia&quot;</span>
<span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;All articles for a given language- and version-specific &quot;</span>
    <span class="s2">&quot;Wikipedia site snapshot.&quot;</span>
<span class="p">)</span>
<span class="n">SITE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://meta.wikimedia.org/wiki/Data_dumps&quot;</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">NAME</span><span class="p">)</span>

<span class="n">DOWNLOAD_ROOT</span> <span class="o">=</span> <span class="s2">&quot;https://dumps.wikimedia.org/&quot;</span>

<span class="n">MAPPING_CAT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;cs&quot;</span><span class="p">:</span> <span class="s2">&quot;Kategorie:&quot;</span><span class="p">,</span>
    <span class="s2">&quot;de&quot;</span><span class="p">:</span> <span class="s2">&quot;Kategorie:&quot;</span><span class="p">,</span>
    <span class="s2">&quot;en&quot;</span><span class="p">:</span> <span class="s2">&quot;Category:&quot;</span><span class="p">,</span>
    <span class="s2">&quot;es&quot;</span><span class="p">:</span> <span class="s2">&quot;Categoría:&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fr&quot;</span><span class="p">:</span> <span class="s2">&quot;Catégorie:&quot;</span><span class="p">,</span>
    <span class="s2">&quot;it&quot;</span><span class="p">:</span> <span class="s2">&quot;Categoria:&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nl&quot;</span><span class="p">:</span> <span class="s2">&quot;Categorie:&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pt&quot;</span><span class="p">:</span> <span class="s2">&quot;Categoria:&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># project name -&gt; canonical wikimedia dump project name</span>
<span class="n">PROJECTS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;wikipedia&quot;</span><span class="p">:</span> <span class="s2">&quot;wiki&quot;</span><span class="p">,</span> <span class="s2">&quot;wikinews&quot;</span><span class="p">:</span> <span class="s2">&quot;wikinews&quot;</span><span class="p">}</span>
<span class="c1"># useful for error messages</span>
<span class="n">PROJECTS_INV</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">PROJECTS</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># nowiki tags: take contents verbatim</span>
<span class="n">re_nowiki</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;nowiki&gt;(.*?)&lt;/nowiki&gt;&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>

<span class="n">self_closing_tags</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;br&quot;</span><span class="p">,</span> <span class="s2">&quot;hr&quot;</span><span class="p">,</span> <span class="s2">&quot;nobr&quot;</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">,</span> <span class="s2">&quot;references&quot;</span><span class="p">)</span>
<span class="n">re_self_closing_html_tags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;&lt;\s?(</span><span class="si">%s</span><span class="s2">)\b[^&gt;]*/\s?&gt;&quot;</span> <span class="o">%</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">self_closing_tags</span><span class="p">),</span>
    <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ignored_html_tags</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;abbr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;b&quot;</span><span class="p">,</span>
    <span class="s2">&quot;big&quot;</span><span class="p">,</span>
    <span class="s2">&quot;blockquote&quot;</span><span class="p">,</span>
    <span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cite&quot;</span><span class="p">,</span>
    <span class="s2">&quot;em&quot;</span><span class="p">,</span>
    <span class="s2">&quot;font&quot;</span><span class="p">,</span>
    <span class="s2">&quot;h1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;h2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;h3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;h4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hiero&quot;</span><span class="p">,</span>
    <span class="s2">&quot;i&quot;</span><span class="p">,</span>
    <span class="s2">&quot;kbd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;p&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plaintext&quot;</span><span class="p">,</span>
    <span class="s2">&quot;s&quot;</span><span class="p">,</span>
    <span class="s2">&quot;span&quot;</span><span class="p">,</span>
    <span class="s2">&quot;strike&quot;</span><span class="p">,</span>
    <span class="s2">&quot;strong&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;u&quot;</span><span class="p">,</span>
    <span class="s2">&quot;var&quot;</span><span class="p">,</span>
    <span class="s2">&quot;math&quot;</span><span class="p">,</span>
    <span class="s2">&quot;code&quot;</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># are math and code okay here?</span>
<span class="n">re_ignored_html_tags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;&lt;(</span><span class="si">%s</span><span class="s2">)\b.*?&gt;(.*?)&lt;/\s*\1&gt;&quot;</span> <span class="o">%</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ignored_html_tags</span><span class="p">),</span>
    <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">dropped_elements</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;caption&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dir&quot;</span><span class="p">,</span>
    <span class="s2">&quot;div&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dl&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;form&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gallery&quot;</span><span class="p">,</span>
    <span class="s2">&quot;imagemap&quot;</span><span class="p">,</span>
    <span class="s2">&quot;img&quot;</span><span class="p">,</span>
    <span class="s2">&quot;indicator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;li&quot;</span><span class="p">,</span>
    <span class="s2">&quot;menu&quot;</span><span class="p">,</span>
    <span class="s2">&quot;noinclude&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ol&quot;</span><span class="p">,</span>
    <span class="s2">&quot;option&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pre&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ref&quot;</span><span class="p">,</span>
    <span class="s2">&quot;references&quot;</span><span class="p">,</span>
    <span class="s2">&quot;select&quot;</span><span class="p">,</span>
    <span class="s2">&quot;small&quot;</span><span class="p">,</span>
    <span class="s2">&quot;source&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sub&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sup&quot;</span><span class="p">,</span>
    <span class="s2">&quot;table&quot;</span><span class="p">,</span>
    <span class="s2">&quot;td&quot;</span><span class="p">,</span>
    <span class="s2">&quot;textarea&quot;</span><span class="p">,</span>
    <span class="s2">&quot;th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;timeline&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ul&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">re_dropped_elements</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;&lt;\s*(</span><span class="si">%s</span><span class="s2">)\b[^&gt;/]*&gt;.*?&lt;\s*/\s*\1&gt;&quot;</span> <span class="o">%</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dropped_elements</span><span class="p">),</span>
    <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># text formatting</span>
<span class="n">re_italic_quote</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&#39;&#39;</span><span class="se">\&quot;</span><span class="s2">([^</span><span class="se">\&quot;</span><span class="s2">]*?)</span><span class="se">\&quot;</span><span class="s2">&#39;&#39;&quot;</span><span class="p">)</span>
<span class="n">re_bold_italic</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&#39;{2,5}(.*?)&#39;{2,5}&quot;</span><span class="p">)</span>
<span class="n">re_quote_quote</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;&quot;([^&quot;]*?)&quot;&quot;&#39;</span><span class="p">)</span>

<span class="c1"># text normalization</span>
<span class="n">re_spaces</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot; {2,}&quot;</span><span class="p">)</span>
<span class="n">re_linebreaks</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\n{3,}&quot;</span><span class="p">)</span>
<span class="n">re_dots</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.{4,}&quot;</span><span class="p">)</span>
<span class="n">re_brackets</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[\s?\]|\(\s?\)&quot;</span><span class="p">)</span>

<span class="n">re_comments</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;&lt;!--.*?--&gt;&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>

<span class="n">re_categories</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;\[\[(</span><span class="si">{}</span><span class="s2">)[^\]\[]*\]\]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MAPPING_CAT</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
    <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">re_link_trails</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
<span class="n">re_ext_link</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?&lt;!\[)\[([^\[\]]*?)\]&quot;</span><span class="p">)</span>
<span class="n">re_table_formatting</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">\s*(({\|)|(\|-+)|(\|})).*?(?=</span><span class="se">\n</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
<span class="n">re_table_cell_formatting</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">\s*(\||\!)(.*?\|)*([^|]*?)&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
<span class="n">re_headings</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(={2,6})\s*(.*?)\s*\1&quot;</span><span class="p">)</span>
<span class="n">re_files_images</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">\[\[(?:Image|File)(?:.*?)(\|.*?)*\|(.*?)\]\]&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span>
<span class="p">)</span>
<span class="n">re_random_cruft</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot; (,:\.\)\]»)|(\[\(«) &quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>

<span class="n">magic_words</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;__NOTOC__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__FORCETOC__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__TOC__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__NEWSECTIONLINK__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__NONEWSECTIONLINK__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__NOGALLERY__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__HIDDENCAT__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__NOCONTENTCONVERT__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__NOCC__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__NOTITLECONVERT__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__NOTC__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__START__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__END__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__INDEX__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__NOINDEX__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__STATICREDIRECT__&quot;</span><span class="p">,</span>
    <span class="s2">&quot;__DISAMBIG__&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">re_magic_words</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">magic_words</span><span class="p">))</span>


<div class="viewcode-block" id="Wikipedia"><a class="viewcode-back" href="../../../api_reference.html#textacy.datasets.wikipedia.Wikipedia">[docs]</a><span class="k">class</span> <span class="nc">Wikipedia</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stream Wikipedia articles from versioned, language-specific database dumps,</span>
<span class="sd">    either as texts (str) or records (dict) with both text content and metadata.</span>

<span class="sd">    Download a database dump for a given language and version::</span>

<span class="sd">        &gt;&gt;&gt; wp = Wikipedia(lang=&#39;en&#39;, version=&#39;latest&#39;)</span>
<span class="sd">        &gt;&gt;&gt; wp.download()</span>
<span class="sd">        &gt;&gt;&gt; wp.info</span>
<span class="sd">        {&#39;data_dir&#39;: &#39;path/to/textacy/data/wikipedia&#39;,</span>
<span class="sd">         &#39;description&#39;: &#39;All articles for a given Wikimedia wiki, including wikitext source and metadata, as a single database dump in XML format.&#39;,</span>
<span class="sd">         &#39;name&#39;: &#39;wikipedia&#39;,</span>
<span class="sd">         &#39;site_url&#39;: &#39;https://meta.wikimedia.org/wiki/Data_dumps&#39;}</span>

<span class="sd">    Iterate over articles as plain texts or records with both text and metadata::</span>

<span class="sd">        &gt;&gt;&gt; for text in wp.texts(limit=5):</span>
<span class="sd">        ...     print(text)</span>
<span class="sd">        &gt;&gt;&gt; for record in wp.records(limit=5):</span>
<span class="sd">        ...     print(record[&#39;title&#39;], record[&#39;text&#39;][:500])</span>

<span class="sd">    Filter articles by text length::</span>

<span class="sd">        &gt;&gt;&gt; for text in wp.texts(min_len=1000, limit=1):</span>
<span class="sd">        ...     print(text)</span>

<span class="sd">    Args:</span>
<span class="sd">        data_dir (str): Path to directory on disk under which database dump</span>
<span class="sd">            files are stored. Each file is expected as</span>
<span class="sd">            ``{lang}{project}/{version}/{lang}{project}-{version}-pages-articles.xml.bz2``</span>
<span class="sd">            immediately under this directory.</span>
<span class="sd">        lang (str): Standard two-letter language code, e.g. &quot;en&quot; =&gt; &quot;English&quot;,</span>
<span class="sd">            &quot;de&quot; =&gt; &quot;German&quot;. https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes</span>
<span class="sd">        version (str): Database dump version to use. Either &quot;latest&quot; for the</span>
<span class="sd">            most recently available version or a date formatted as &quot;YYYYMMDD&quot;.</span>
<span class="sd">            Dumps are produced intermittently; check for available versions at</span>
<span class="sd">            https://meta.wikimedia.org/wiki/Data_dumps.</span>
<span class="sd">        project (str): Name of wikimedia project. Currently, only &#39;wikipedia&#39;</span>
<span class="sd">            (default) and &#39;wikinews&#39; are supported.</span>
<span class="sd">        namespace (str): Allows one to specify a namespace other than &#39;0&#39;</span>
<span class="sd">            (the default) to extract content from</span>


<span class="sd">    Attributes:</span>
<span class="sd">        lang (str): Standard two-letter language code used in instantiation.</span>
<span class="sd">        version (str): Database dump version used in instantiation.</span>
<span class="sd">        filestub (str): The component of ``filename`` that is unique to this</span>
<span class="sd">            lang- and version-specific database dump.</span>
<span class="sd">        filename (str): Full path on disk for the lang- and version-specific</span>
<span class="sd">            Wikipedia database dump, found under the ``data_dir`` directory.</span>
<span class="sd">        project (str): the canonical name for the wikimedia project which is</span>
<span class="sd">            used as a component of ``filestub``.</span>

<span class="sd">    Notes:</span>
<span class="sd">        Namespace values can be discovered via ``bzcat dumpfile.xml.bz2 | head``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_dir</span><span class="o">=</span><span class="n">DATA_DIR</span><span class="p">,</span>
        <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="s2">&quot;latest&quot;</span><span class="p">,</span>
        <span class="n">project</span><span class="o">=</span><span class="s2">&quot;wikipedia&quot;</span><span class="p">,</span>
        <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Wikipedia</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">NAME</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">DESCRIPTION</span><span class="p">,</span> <span class="n">site_url</span><span class="o">=</span><span class="n">SITE_URL</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="k">if</span> <span class="n">project</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PROJECTS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid or unsupported wikimedia project: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">PROJECTS</span><span class="p">[</span><span class="n">project</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filestub</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{lang}{project}</span><span class="s2">/</span><span class="si">{version}</span><span class="s2">/</span><span class="si">{lang}{project}</span><span class="s2">-</span><span class="si">{version}</span><span class="s2">-pages-articles.xml.bz2&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filestub</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span> <span class="o">=</span> <span class="n">namespace</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        str: Full path on disk for Wikipedia database dump corresponding to</span>
<span class="sd">            the ``lang`` and ``version`` used in instantiation.</span>
<span class="sd">            ``None`` if file not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_verify_dump_file_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dumpfile_url</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">dumpfile_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="c1"># invalid dump file url. check that {lang}{project} exists</span>
            <span class="n">lang_project_url</span> <span class="o">=</span> <span class="n">compat</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span>
                <span class="n">DOWNLOAD_ROOT</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">{lang}{project}</span><span class="s2">/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">res2</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">lang_project_url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res2</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;</span><span class="si">{lang}</span><span class="s2">&#39; variant of &#39;</span><span class="si">{project}</span><span class="s2">&#39; does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">lang</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">PROJECTS_INV</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># lang/project exists, just bad dumpfile url</span>
                <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span>
                    <span class="s2">&quot;404: Not Found. </span><span class="si">{url}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">dumpfile_url</span><span class="p">)</span>
                <span class="p">)</span>

<div class="viewcode-block" id="Wikipedia.download"><a class="viewcode-back" href="../../../api_reference.html#textacy.datasets.wikipedia.Wikipedia.download">[docs]</a>    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download the data corresponding to the given ``lang`` and ``version``</span>
<span class="sd">        as a compressed XML file and save it to disk under the ``data_dir`` directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            force (bool): If True, download the dataset, even if it already</span>
<span class="sd">                exists on disk under ``data_dir``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">compat</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">DOWNLOAD_ROOT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filestub</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="ow">and</span> <span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> already exists; skipping download...&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Downloading data from </span><span class="si">%s</span><span class="s2"> and writing it to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_dump_file_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">io</span><span class="o">.</span><span class="n">write_http_stream</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">make_dirs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterate over the pages of a Wikipedia articles database dump,</span>
<span class="sd">        yielding one (page id, page title, page content) triplet at a time.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Tuple[str, str, str]: Page id, title, content with wikimedia markup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> file not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">compat</span><span class="o">.</span><span class="n">is_python2</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open_sesame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Python 2 can&#39;t open bzip in text mode :(</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;end&quot;</span><span class="p">,)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open_sesame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">f</span><span class="p">:</span>

            <span class="n">elems</span> <span class="o">=</span> <span class="p">(</span><span class="n">elem</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">iterparse</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">))</span>

            <span class="n">elem</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^{(.*?)}&quot;</span><span class="p">,</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http://www.mediawiki.org/xml/export-&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;namespace &quot;</span><span class="si">{}</span><span class="s1">&quot; not a valid MediaWiki dump namespace&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">namespace</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">page_tag</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}page&quot;</span> <span class="o">%</span> <span class="n">namespace</span>
            <span class="n">ns_path</span> <span class="o">=</span> <span class="s2">&quot;./{</span><span class="si">%s</span><span class="s2">}ns&quot;</span> <span class="o">%</span> <span class="n">namespace</span>
            <span class="n">page_id_path</span> <span class="o">=</span> <span class="s2">&quot;./{</span><span class="si">%s</span><span class="s2">}id&quot;</span> <span class="o">%</span> <span class="n">namespace</span>
            <span class="n">title_path</span> <span class="o">=</span> <span class="s2">&quot;./{</span><span class="si">%s</span><span class="s2">}title&quot;</span> <span class="o">%</span> <span class="n">namespace</span>
            <span class="n">text_path</span> <span class="o">=</span> <span class="s2">&quot;./{</span><span class="si">%s</span><span class="s2">}revision/{</span><span class="si">%s</span><span class="s2">}text&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">page_tag</span><span class="p">:</span>
                    <span class="n">page_id</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">page_id_path</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">title_path</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
                    <span class="n">ns</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ns_path</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
                    <span class="k">if</span> <span class="n">ns</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">:</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">text_path</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
                    <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">compat</span><span class="o">.</span><span class="n">unicode_</span><span class="p">):</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">compat</span><span class="o">.</span><span class="n">bytes_to_unicode</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span>
                    <span class="n">elem</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">include_headings</span><span class="p">):</span>
        <span class="n">unicode_</span> <span class="o">=</span> <span class="n">compat</span><span class="o">.</span><span class="n">unicode_</span>  <span class="c1"># for performance</span>
        <span class="n">wikicode</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="n">parsed_content</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cat_link</span> <span class="o">=</span> <span class="n">MAPPING_CAT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="p">]</span>
        <span class="c1"># catch category links errantly marked up in lowercase</span>
        <span class="n">lc_cat_link</span> <span class="o">=</span> <span class="n">cat_link</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">wikilinks</span> <span class="o">=</span> <span class="p">[</span><span class="n">unicode_</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">title</span><span class="p">)</span> <span class="k">for</span> <span class="n">wc</span> <span class="ow">in</span> <span class="n">wikicode</span><span class="o">.</span><span class="n">ifilter_wikilinks</span><span class="p">()]</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">wc</span>
            <span class="k">for</span> <span class="n">wc</span> <span class="ow">in</span> <span class="n">wikilinks</span>
            <span class="k">if</span> <span class="n">wc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">cat_link</span><span class="p">)</span> <span class="ow">or</span> <span class="n">wc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">lc_cat_link</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">parsed_content</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">categories</span>
        <span class="n">parsed_content</span><span class="p">[</span><span class="s2">&quot;wiki_links&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">wc</span>
            <span class="k">for</span> <span class="n">wc</span> <span class="ow">in</span> <span class="n">wikilinks</span>
            <span class="k">if</span> <span class="n">wc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categories</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">wc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;File:&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">wc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Image:&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">parsed_content</span><span class="p">[</span><span class="s2">&quot;ext_links&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">unicode_</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">wc</span> <span class="ow">in</span> <span class="n">wikicode</span><span class="o">.</span><span class="n">ifilter_external_links</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="c1"># worse quality, but significantly faster</span>
        <span class="c1"># just strip the markup from unicode, as is done for `.texts()`</span>
        <span class="k">if</span> <span class="n">fast</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">parsed_content</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strip_markup</span><span class="p">(</span><span class="n">unicode_</span><span class="p">(</span><span class="n">wikicode</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">re_image_wl</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="s2">&quot;^(?:File|Image|Media):&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span>
            <span class="p">)</span>
            <span class="n">bad_template_names</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;reflist&quot;</span><span class="p">,</span>
                <span class="s2">&quot;notelist&quot;</span><span class="p">,</span>
                <span class="s2">&quot;notelist-ua&quot;</span><span class="p">,</span>
                <span class="s2">&quot;notelist-lr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;notelist-ur&quot;</span><span class="p">,</span>
                <span class="s2">&quot;notelist-lg&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">bad_tags</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ref&quot;</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">}</span>

            <span class="k">def</span> <span class="nf">is_bad_wikilink</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re_image_wl</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">unicode_</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">title</span><span class="p">)))</span>

            <span class="k">def</span> <span class="nf">is_bad_tag</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">unicode_</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span> <span class="ow">in</span> <span class="n">bad_tags</span>

            <span class="k">def</span> <span class="nf">is_bad_template</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">bad_template_names</span>

            <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># strip out references, tables, and file/image links</span>
            <span class="c1"># then concatenate the stripped text of each section</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="n">wikicode</span><span class="o">.</span><span class="n">get_sections</span><span class="p">(</span>
                    <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_lead</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_headings</span><span class="o">=</span><span class="n">include_headings</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">section</span><span class="o">.</span><span class="n">ifilter_wikilinks</span><span class="p">(</span>
                    <span class="n">matches</span><span class="o">=</span><span class="n">is_bad_wikilink</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">section</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">section</span><span class="o">.</span><span class="n">ifilter_templates</span><span class="p">(</span>
                    <span class="n">matches</span><span class="o">=</span><span class="n">is_bad_template</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">section</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">section</span><span class="o">.</span><span class="n">ifilter_tags</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="n">is_bad_tag</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">section</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="o">.</span><span class="n">strip_code</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="n">parsed_content</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parsed_content</span>

<div class="viewcode-block" id="Wikipedia.texts"><a class="viewcode-back" href="../../../api_reference.html#textacy.datasets.wikipedia.Wikipedia.texts">[docs]</a>    <span class="k">def</span> <span class="nf">texts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_len</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">limit</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterate over pages (text-only) in a Wikipedia database dump, optionally</span>
<span class="sd">        filtering by text length.</span>

<span class="sd">        Args:</span>
<span class="sd">            min_len (int): Minimum length in chars that a page must have</span>
<span class="sd">                for it to be returned; too-short pages are skipped.</span>
<span class="sd">            limit (int): Maximum number of pages (passing ``min_len``) to yield;</span>
<span class="sd">                if -1, all pages in the db dump are iterated over.</span>
<span class="sd">        Yields:</span>
<span class="sd">            str: Full text of next page in the Wikipedia database dump.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Page and section titles appear immediately before the text content</span>
<span class="sd">            that they label, separated by an empty line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_pages</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">strip_markup</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_len</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="n">title</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">text</span>

            <span class="n">n_pages</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">n_pages</span> <span class="o">==</span> <span class="n">limit</span><span class="p">:</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="Wikipedia.records"><a class="viewcode-back" href="../../../api_reference.html#textacy.datasets.wikipedia.Wikipedia.records">[docs]</a>    <span class="k">def</span> <span class="nf">records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_len</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">limit</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_headings</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterate over pages (parsed text and metadata) in a Wikipedia database dump,</span>
<span class="sd">        optionally filtering by text length.</span>

<span class="sd">        Args:</span>
<span class="sd">            min_len (int): Minimum length in chars that a page must have</span>
<span class="sd">                for it to be returned; too-short pages are skipped.</span>
<span class="sd">            limit (int): Maximum number of pages (passing ``min_len``) to yield;</span>
<span class="sd">                if -1, all pages in the db dump are iterated over.</span>
<span class="sd">            fast (bool): If True, text is extracted using a faster method but</span>
<span class="sd">                which gives lower quality results. Otherwise, a slower but better</span>
<span class="sd">                method is used to extract article text.</span>
<span class="sd">            include_headings (bool): Whether to include section headings and</span>
<span class="sd">                the page title as part of the page&#39;s text. Default: True</span>
<span class="sd">        Yields:</span>
<span class="sd">            dict: Parsed text and metadata of next page in the Wikipedia database dump.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This function requires `mwparserfromhell &lt;mwparserfromhell.readthedocs.org&gt;`_.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mwparserfromhell</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;`mwparserfromhell` is not installed, so :meth:`Wikipedia.records()` &quot;</span>
                <span class="s2">&quot;won&#39;t work; install it via `$ pip install mwparserfromhell`.&quot;</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">For details, see http://pythonhosted.org/mwparserfromhell/.&quot;</span>
            <span class="p">)</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">mwparserfromhell</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">Parser</span><span class="p">()</span>

        <span class="n">n_pages</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_content</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">include_headings</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">min_len</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">page</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
            <span class="n">page</span><span class="p">[</span><span class="s2">&quot;page_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_id</span>
            <span class="k">if</span> <span class="n">include_headings</span><span class="p">:</span>
                <span class="n">page</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">page</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>

            <span class="k">yield</span> <span class="n">page</span>

            <span class="n">n_pages</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">n_pages</span> <span class="o">==</span> <span class="n">limit</span><span class="p">:</span>
                <span class="k">break</span></div></div>


<div class="viewcode-block" id="strip_markup"><a class="viewcode-back" href="../../../api_reference.html#textacy.datasets.wikipedia.strip_markup">[docs]</a><span class="k">def</span> <span class="nf">strip_markup</span><span class="p">(</span><span class="n">wikitext</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Strip Wikimedia markup from the (wiki-)text content of a Wikipedia page and</span>
<span class="sd">    return the page as plain-text.</span>

<span class="sd">    Args:</span>
<span class="sd">        wikitext (str)</span>

<span class="sd">    Returns:</span>
<span class="sd">        str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wikitext</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># remove templates</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">_remove_templates</span><span class="p">(</span><span class="n">wikitext</span><span class="p">)</span>

    <span class="c1"># remove irrelevant spans</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_comments</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_ignored_html_tags</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\2&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_self_closing_html_tags</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_dropped_elements</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_categories</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_files_images</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># TODO: keep file/image captions?</span>

    <span class="c1"># replace external links with just labels or just URLs</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">_replace_external_links</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="c1"># drop magic words behavioral switches</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_magic_words</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="c1"># replace internal links with just their labels</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">_replace_internal_links</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="c1"># text = _replace_internal_links(text)  # TODO: is this needed?</span>

    <span class="c1"># remove table markup</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;||&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="s2">&quot;!!&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">!&quot;</span>
    <span class="p">)</span>  <span class="c1"># put each cell on a separate line</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_table_formatting</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># remove formatting lines</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_table_cell_formatting</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\\</span><span class="s2">3&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># leave only cell content</span>

    <span class="c1"># strip out text formatting</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_italic_quote</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;\1&quot;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_bold_italic</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_quote_quote</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;\1&quot;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="c1"># unescape html entities</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">ftfy</span><span class="o">.</span><span class="n">fixes</span><span class="o">.</span><span class="n">unescape_html</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="c1"># final cleanup</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_headings</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\n\n\2\n\n&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_dots</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_brackets</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[[&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;«&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;»&quot;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_random_cruft</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\n\W+?\n&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\n&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,,&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,.&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_spaces</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_linebreaks</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\n\n&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">_remove_templates</span><span class="p">(</span><span class="n">wikitext</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return ``wikitext`` with all wikimedia markup templates removed,</span>
<span class="sd">    where templates are identified by opening &#39;{{&#39; and closing &#39;}}&#39;.</span>

<span class="sd">    See also:</span>
<span class="sd">        http://meta.wikimedia.org/wiki/Help:Template</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pieces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cur_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">_get_delimited_spans</span><span class="p">(</span><span class="n">wikitext</span><span class="p">,</span> <span class="n">open_delim</span><span class="o">=</span><span class="s2">&quot;{{&quot;</span><span class="p">,</span> <span class="n">close_delim</span><span class="o">=</span><span class="s2">&quot;}}&quot;</span><span class="p">):</span>
        <span class="n">pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wikitext</span><span class="p">[</span><span class="n">cur_idx</span><span class="p">:</span><span class="n">s</span><span class="p">])</span>
        <span class="n">cur_idx</span> <span class="o">=</span> <span class="n">e</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span>
    <span class="c1"># below is gensim&#39;s solution; it&#39;s slow...</span>
    <span class="c1"># n_openings = 0</span>
    <span class="c1"># n_closings = 0</span>
    <span class="c1"># opening_idxs = []</span>
    <span class="c1"># closing_idxs = []</span>
    <span class="c1"># in_template = False</span>
    <span class="c1"># prev_char = None</span>
    <span class="c1"># for i, char in enumerate(wikitext):</span>
    <span class="c1">#     if not in_template:</span>
    <span class="c1">#         if char == &#39;{&#39; and prev_char == &#39;{&#39;:</span>
    <span class="c1">#             opening_idxs.append(i - 1)</span>
    <span class="c1">#             in_template = True</span>
    <span class="c1">#             n_openings = 2</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         if char == &#39;{&#39;:</span>
    <span class="c1">#             n_openings += 1</span>
    <span class="c1">#         elif char == &#39;}&#39;:</span>
    <span class="c1">#             n_closings += 1</span>
    <span class="c1">#         if n_openings == n_closings:</span>
    <span class="c1">#             closing_idxs.append(i)</span>
    <span class="c1">#             in_template = False</span>
    <span class="c1">#             n_openings = 0</span>
    <span class="c1">#             n_closings = 0</span>
    <span class="c1">#     prev_char = char</span>
    <span class="c1"># return &#39;&#39;.join(</span>
    <span class="c1">#     wikitext[closing_idx + 1: opening_idx]</span>
    <span class="c1">#     for opening_idx, closing_idx in zip(opening_idxs + [None], [-1] + closing_idxs))</span>


<span class="k">def</span> <span class="nf">_get_delimited_spans</span><span class="p">(</span><span class="n">wikitext</span><span class="p">,</span> <span class="n">open_delim</span><span class="o">=</span><span class="s2">&quot;[[&quot;</span><span class="p">,</span> <span class="n">close_delim</span><span class="o">=</span><span class="s2">&quot;]]&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        wikitext (str)</span>
<span class="sd">        open_delim (str)</span>
<span class="sd">        close_delim (str)</span>

<span class="sd">    Yields:</span>
<span class="sd">        Tuple[int, int]: start and end index of next span delimited by</span>
<span class="sd">            ``open_delim`` on the left and ``close_delim`` on the right</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">open_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">open_delim</span><span class="p">)</span>
    <span class="n">re_open</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">open_pattern</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
    <span class="n">re_open_or_close</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">open_pattern</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">close_delim</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span>
    <span class="p">)</span>

    <span class="n">openings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cur_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">started</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">re_next</span> <span class="o">=</span> <span class="n">re_open</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">next_span</span> <span class="o">=</span> <span class="n">re_next</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">wikitext</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">cur_idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">next_span</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">started</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">next_span</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">started</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">delim</span> <span class="o">=</span> <span class="n">next_span</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">delim</span> <span class="o">==</span> <span class="n">open_delim</span><span class="p">:</span>
            <span class="n">openings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span>
            <span class="n">re_next</span> <span class="o">=</span> <span class="n">re_open_or_close</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">openings</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">openings</span><span class="p">:</span>
                <span class="n">re_next</span> <span class="o">=</span> <span class="n">re_open_or_close</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">next_span</span><span class="o">.</span><span class="n">end</span><span class="p">())</span>
                <span class="n">re_next</span> <span class="o">=</span> <span class="n">re_open</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">next_span</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                <span class="n">started</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">cur_idx</span> <span class="o">=</span> <span class="n">next_span</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_replace_internal_links</span><span class="p">(</span><span class="n">wikitext</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace internal links of the form ``[[title |...|label]]trail``</span>
<span class="sd">    with just ``label``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pieces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cur_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">_get_delimited_spans</span><span class="p">(</span><span class="n">wikitext</span><span class="p">,</span> <span class="s2">&quot;[[&quot;</span><span class="p">,</span> <span class="s2">&quot;]]&quot;</span><span class="p">):</span>
        <span class="n">link_trail</span> <span class="o">=</span> <span class="n">re_link_trails</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">wikitext</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">link_trail</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">link_trail</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="n">link_trail</span> <span class="o">=</span> <span class="n">link_trail</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">link_trail</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">span_content</span> <span class="o">=</span> <span class="n">wikitext</span><span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">e</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">pipe_idx</span> <span class="o">=</span> <span class="n">span_content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pipe_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">span_content</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_pipe_idx</span> <span class="o">=</span> <span class="n">span_content</span><span class="p">[</span><span class="n">pipe_idx</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">span_content</span><span class="p">[</span><span class="n">pipe_idx</span> <span class="o">+</span> <span class="n">last_pipe_idx</span> <span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wikitext</span><span class="p">[</span><span class="n">cur_idx</span><span class="p">:</span><span class="n">s</span><span class="p">])</span>
        <span class="n">pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">cur_idx</span> <span class="o">=</span> <span class="n">end</span>
    <span class="c1"># add leftovers</span>
    <span class="n">pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wikitext</span><span class="p">[</span><span class="n">cur_idx</span><span class="p">:])</span>

    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_replace_external_links</span><span class="p">(</span><span class="n">wikitext</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace external links of the form ``[URL text]`` with just</span>
<span class="sd">    ``text`` if present or just ``URL`` if not.</span>

<span class="sd">    See also:</span>
<span class="sd">        https://www.mediawiki.org/wiki/Help:Links#External_links</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pieces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cur_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re_ext_link</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">wikitext</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">space_idx</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">space_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span> <span class="k">if</span> <span class="n">space_idx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">content</span>
        <span class="n">pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wikitext</span><span class="p">[</span><span class="n">cur_idx</span> <span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()])</span>
        <span class="n">pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">cur_idx</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
    <span class="c1"># add leftovers</span>
    <span class="n">pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wikitext</span><span class="p">[</span><span class="n">cur_idx</span><span class="p">:])</span>

    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">textacy</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016 Chartbeat, Inc..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>